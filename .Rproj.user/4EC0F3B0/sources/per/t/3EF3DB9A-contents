---
title: 'Google Data Analytics: Cyclistic'
author: "Jacky Dwiyanto"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = F, fig.width = 12, fig.height=8)
```

## Foreword
I recently completed my [Google Data Analytics Professional certificate](https://www.coursera.org/account/accomplishments/professional-cert/TQF78JLHP2WT?utm_source=link&utm_medium=certificate&utm_content=cert_image&utm_campaign=sharing_cta&utm_product=prof)  and at the end of the course was provided with this set of real world data which has been anonymysed as belonging to a fictional company called 'Cyclistic', and were given instructions to run analytics on it. So here's my take on it.

## Scenario
You are a junior data analyst working in the marketing analyst team at Cyclistic, a bike-share company in Chicago. The director of marketing believes the company’s future success depends on maximizing the number of annual memberships. Therefore, your team wants to understand how casual riders and annual members use Cyclistic bikes differently. From these insights, your team will design a new marketing strategy to convert casual riders into annual members. But first, Cyclistic executives must approve your recommendations, so they must be backed up with compelling data insights and professional data visualizations.

## Characters and Teams

* **Cyclistic**: A bike-share program that features more than 5,800 bicycles and 600 docking stations. Cyclistic sets itself apart by also offering reclining bikes, hand tricycles, and cargo bikes, making bike-share more inclusive to people with disabilities and riders who can’t use a standard two-wheeled bike. The majority of riders opt for traditional bikes; about 8% of riders use the assistive options. Cyclistic users are more likely to ride for leisure, but about 30% use them to commute to work each day.
* **Lily Moreno**: The director of marketing and your manager. Moreno is responsible for the development of campaigns and initiatives to promote the bike-share program. These may include email, social media, and other channels. 
* **Cyclistic marketing analytics team**: A team of data analysts who are responsible for collecting, analyzing, and reporting data that helps guide Cyclistic marketing strategy. You joined this team six months ago and have been busy learning about Cyclistic’s mission and business goals — as well as how you, as a junior data analyst, can help Cyclistic achieve them.
* **Cyclistic executive team**: The notoriously detail-oriented executive team will decide whether to approve the recommended marketing program.

## About the company 
In 2016, Cyclistic launched a successful bike-share offering. Since then, the program has grown to a fleet of 5,824 bicycles that are geotracked and locked into a network of 692 stations across Chicago. The bikes can be unlocked from one station and returned to any other station in the system anytime. Until now, Cyclistic’s marketing strategy relied on building general awareness and appealing to broad consumer segments. One approach that helped make these things possible was the flexibility of its pricing plans: single-ride passes, full-day passes, and annual memberships. Customers who purchase single-ride or full-day passes are referred to as casual riders. Customers who purchase annual memberships are Cyclistic members. Cyclistic’s finance analysts have concluded that annual members are much more profitable than casual riders. Although the pricing flexibility helps Cyclistic attract more customers, Moreno believes that maximizing the number of annual members will be key to future growth. Rather than creating a marketing campaign that targets all-new customers, Moreno believes there is a very good chance to convert casual riders into members. She notes that casual riders are already aware of the Cyclistic program and have chosen Cyclistic for their mobility needs. Moreno has set a clear goal: Design marketing strategies aimed at converting casual riders into annual members. In order to do that, however, the marketing analyst team needs to better understand how annual members and casual riders differ, why casual riders would buy a membership, and how digital media could affect their marketing tactics. Moreno and her team are interested in analyzing the Cyclistic historical bike trip data to identify trends.

## Ask
Three questions will guide the future marketing program:

1. How do annual members and casual riders use Cyclistic bikes differently?
2. Why would casual riders buy Cyclistic annual memberships?
3. How can Cyclistic use digital media to influence casual riders to become members?
Moreno has assigned you the first question to answer: How do annual members and casual riders use Cyclistic bikes differently?

You will produce a report with the following deliverables:

1. A clear statement of the business task
2. A description of all data sources used
3. Documentation of any cleaning or manipulation of data
4. A summary of your analysis
5. Supporting visualizations and key findings
6. Your top three recommendations based on your analysis

## My analytics workflow

From the background given, the finance analyst of Cyclistic has reported that annual member generates more profit for the company than casual riders, and the director has instructed for a new marketing campaign aiming to convert existing casual riders into annual members. The analytics team generates the above three questions in order to understand annual vs casual riders better to provide some data to drive the market strategy to convert casual into annual members. 
Problem statement: How to convert Cyclistic's casual riders into annual members?

## Downloading the dataset
You will use Cyclistic’s historical trip data to analyze and identify trends. Download the previous 12 months of Cyclistic trip data [here](https://divvy-tripdata.s3.amazonaws.com/index.html). (Note: The datasets have a different name because Cyclistic is a fictional company. For the purposes of this case study, the datasets are appropriate and will enable you to answer the business questions. The data has been made available by Motivate International Inc. under this license.) This is public data that you can use to explore how different customer types are using Cyclistic bikes. But note that data-privacy issues prohibit you from using riders’ personally identifiable information. This means that you won’t be able to connect pass purchases to credit card numbers to determine if casual riders live in the Cyclistic service area or if they have purchased multiple single passes.

## Prepare: my take
The instruction brought us to a AWS S3 bucket index page which provides the links for all the data to be downloaded. However, I wasn't able to bulk download the data directly through AWS command line interface; for some reason my access was always restricted. 

Instead of clicking each link and downloading them manually, I utilised the Ubuntu CLI to scrape the URL links from the index page, then loop a simple wget function to download all files in one command. 

First off, save the index page https://divvy-tripdata.s3.amazonaws.com/index.html as a text file. I then open the text file in a Ubuntu terminal and used grep, sed and awk to filter only the working URLs to each of the sample data.

```{bash eval=F}
cat divvy_text.txt | \ # read file
grep https | \ # filter only line with https pattern 
awk -F "\t" '{print $1}' | \ # print only the first variable in line, separated by a tab
sed 's/<//' | \ # remove the character < before each https link
sed 's/>//' | \ # remove the character > after each https link
sed '$ d' \ # remove last line 
> divvy_url.txt # save as new file

cat divvy_text.txt | grep https | awk -F "\t" '{print $1}' | sed 's/<//' | sed 's/>//' | sed '$ d' > divvy_url.txt
```

Afterwards, we can simply bulk download all the sample files using the following wget command

```{bash eval=F}
wget -i divvy_url.txt
```

There are a lot of zipped files here! I'm not sure if I am supposed to only use one of them or all of them at this stage, but to be safe, I unzip all of them in the terminals using the following for-loop:

```{bash eval=F}
for line in `ls | sed 's/.zip//'`; do unzip ${line}.zip -d ${line}; done # for loop to unzip all files into their individual folders
rm *zip       # delete zip files
mv */*csv .   # move only csv file into main directory
rm -rf `ls -d */` # remove folders after copying the csv files
```

Now all the raw data is in a single directory. Let's view them:

```{r}
list.files('input/raw')
```

We will utilise data from 2020-2022 to get the trend of the last 3 years. Since each month's trip data is saved to a different file, let's merge them together to facilitate a thorough analysis. 

```{r}
library(tidyverse)

tripdatalist = list.files(path = 'input/raw', pattern = 'tripdata.csv', full.names = T)

tripdataall = 
  lapply(tripdatalist, function(x) {
  out = 
    read_csv(x) %>% 
    mutate(start_station_id = as.character(start_station_id),
           end_station_id = as.character(end_station_id))      # to prevent error when merging due to incompatible variable type
}) 

tripdata = dplyr::bind_rows(tripdataall)

rm(tripdataall) # remove the list to save memory
```

I have successfully merged the trip data files together, with a total of `dim(tripdata)[1]` rows and `dim(tripdata)[2]` columns.

We can calculate the trip duration since we have the start and end time for each trip, as well as the distance covered since we have the station geolatitude data. 

Are there any difference in ride duration between members and casual riders? As the duration data was extremely left skewed, I log-transformed the data to achieve a better distribution before plotting them. 

```{r}

# create a subset of whole dataset for ease of analysis

set.seed(123)
tripdata.sub = tripdata %>% slice_sample(n=10000)

tripdata.sub %>% 
  mutate(ride_duration = ended_at - started_at) %>% # calculate trip duration
  filter(ride_duration>0) %>% # remove negative trip duration, assumed to be misinput
  mutate(ride_duration2 = as.integer(ride_duration)) %>%  
  ggplot(aes(x=member_casual, y=log2(ride_duration2), color=member_casual)) + 
  geom_jitter(width=0.2) +
  geom_boxplot(alpha=0.5, outlier.shape = NA) +
  labs(x='Membership', y='Log2 ride duration') + 
  ggpubr::stat_compare_means() +
  theme_bw() +
  theme(legend.position = 'none')
  
```

Interestingly, members seem to have a shorter ride duration than non-members (Wilcoxon test, p<0.05). To see whether this is true all the time, I subset the analysis to each individual months to see whether the trend persisted.

```{r}
tripdata.sub %>%
  mutate(date = lubridate::as_date(started_at),
         ym = str_extract(date, pattern = '^[0-9]{4}-[0-9]{2}')) %>%
  arrange(ym) %>%
  mutate(ride_duration = ended_at - started_at) %>% # calculate trip duration
  filter(ride_duration>0) %>% # remove negative trip duration, assumed to be misinput
  mutate(ride_duration2 = as.integer(ride_duration),
         month = str_extract(string=ym, pattern = '[0-9]{2}$'),
         month2 = ifelse(month %in% c('12','01','02'), 'off', 'peak'),
         year = str_extract(ym, pattern = '^[0-9]{4}') %>% as.numeric()) %>% 
  ggplot(aes(x=month, y=log2(ride_duration2), fill=member_casual)) + 
  geom_boxplot(outlier.size = 0.1) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90)) +
  facet_wrap(~year, scales='free_x') +
  labs(x='Month', y='Log2 Ride Duration')
```

The trend seems to be observed throughout the months and years. 

Next up, we can see whether casual riders or members are more likely to belong to be concentrated to certain are or whether they are uniformly distributed across Chicago. We can infer this by observing the stations most commonly used by casual riders or members. Since there are a lot of different stations to comfortably visualise, let's statistically determine which station had significantly different usage between casual riders and members, and visualise those with significantly different membership proportion.

```{r}
# run one proportion z-test, converting casual to 0 and member to 1 binary

station_start_prop =  
  tripdata.sub %>%
  select(start_station_id, member_casual) %>% 
    count(start_station_id, member_casual) %>%
    pivot_wider(names_from = member_casual, values_from = n, values_fill = 0) %>%
    mutate(total = member+casual) %>%
    filter(total>5) %>% # total sample size of 5 and below will not yield any significant result due to insufficient sample size
    group_by(start_station_id) %>%
    nest(-start_station_id) %>%
    mutate(test = purrr::map(.x = data,
                             .f = ~prop.test(x = .x$member, n= .x$total, p=0.5) %>% broom::tidy())) %>%
    ungroup() %>%
    unnest(data, test) %>%
    select(start_station_id, casual, member, total, p.value) %>%
    filter(p.value < 0.05)

# find IDs of station with higher casual riders than members
casual_startstation = 
  tripdata.sub %>%
  count(start_station_id, member_casual) %>%
  filter(start_station_id %in% station_start_prop$start_station_id) %>%
  drop_na(start_station_id) %>%
  pivot_wider(names_from=member_casual, values_from=n, values_fill = 0) %>%
  mutate(delta = casual-member) %>%
  filter(delta>0) %>%
  arrange(-delta) %>%
  pull(start_station_id)

# generate ref database for station id and name
casual_startstation_ref = 
  tripdata.sub %>%
  select(start_station_id, start_station_name) %>%
  unique

tripdata.sub %>%
  count(start_station_id, member_casual) %>%
  filter(start_station_id %in% station_start_prop$start_station_id) %>%
  drop_na(start_station_id) %>%
  pivot_wider(names_from=member_casual, values_from=n, values_fill = 0) %>%
  mutate(delta = casual-member) %>% 
  pivot_longer(-c('start_station_id', 'delta'), names_to = 'Membership') %>%
  inner_join(casual_startstation_ref, by='start_station_id') %>% 
  mutate(direction = if_else(delta<0, 'Member-dominant', 'Casual-dominant')) %>%
  filter(!is.na(start_station_name)) %>% 
  ggplot(aes(y=reorder(start_station_name, delta), x=value, fill=Membership)) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  labs(x='Usage Frequency', y='Station ID',
       title = 'Origin stations with significantly different proportion\nof casual and member riders') +
  facet_wrap(~direction, scales='free_y') + 
  theme_bw()
  
```

We observed 25 starting stations where the rate of casual riders were significantly higher than members. This is especially true for Streeter Driver & Grand Avenue, as well as Lake Shore Drive & Monroe Street and Millenium Park, where casual riders were several folds higher than member riders. 

Now let's run the same analysis for destination station.

```{r}
# run one proportion z-test, converting casual to 0 and member to 1 binary

station_end_prop =  
  tripdata.sub %>%
  select(end_station_id, member_casual) %>% 
    count(end_station_id, member_casual) %>%
    pivot_wider(names_from = member_casual, values_from = n, values_fill = 0) %>%
    mutate(total = member+casual) %>%
    filter(total>5) %>% # total sample size of 5 and below will not yield any significant result due to insufficient sample size
    group_by(end_station_id) %>%
    nest(-end_station_id) %>%
    mutate(test = purrr::map(.x = data,
                             .f = ~prop.test(x = .x$member, n= .x$total, p=0.5) %>% broom::tidy())) %>%
    ungroup() %>%
    unnest(data, test) %>%
    select(end_station_id, casual, member, total, p.value) %>%
    filter(p.value < 0.05)

# find IDs of station with higher casual riders than members
casual_endstation = 
  tripdata %>%
  count(end_station_id, member_casual) %>%
  filter(end_station_id %in% station_end_prop$end_station_id) %>%
  drop_na(end_station_id) %>%
  pivot_wider(names_from=member_casual, values_from=n, values_fill = 0) %>%
  mutate(delta = casual-member) %>%
  filter(delta>0) %>%
  arrange(-delta) %>%
  pull(end_station_id)

# generate ref database for station id and name
casual_endstation_ref = 
  tripdata.sub %>%
  select(end_station_id, end_station_name) %>%
  unique

tripdata.sub %>%
  count(end_station_id, member_casual) %>%
  filter(end_station_id %in% station_end_prop$end_station_id) %>%
  drop_na(end_station_id) %>%
  pivot_wider(names_from=member_casual, values_from=n, values_fill = 0) %>%
  mutate(delta = casual-member) %>% 
  pivot_longer(-c('end_station_id', 'delta'), names_to = 'Membership') %>%
  inner_join(casual_endstation_ref, by='end_station_id') %>% 
  mutate(direction = if_else(delta<0, 'Member-dominant', 'Casual-dominant')) %>%
  filter(!is.na(end_station_name)) %>% 
  ggplot(aes(y=reorder(end_station_name, delta), x=value, fill=Membership)) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  labs(x='Usage Frequency', y='Station ID',
       title = 'Destination stations with significantly different proportion\nof casual and member riders') +
  facet_wrap(~direction, scales='free_y') + 
  theme_bw()
  
# how many mutual casual-dominant station bw starting and ending st
casual.mutual.st = c(casual_startstation, casual_endstation) 
```

Interestingly, `casual.mutual.st[duplicated(casual.mutual.st)] %>% length` stations were dominated by casual riders both as the starting and ending station. These areas might be within leisure zones, resulting in people to be more likely to come sporadically instead of being a member, although this likely needs to be discussed with a subject matter expert.

What if we considered the overall route taken by casual vs members? Let's find out.

```{r, fig.width=12, fig.height=7}

trip.route = 
   tripdata.sub %>%
    mutate(route = paste0(start_station_id, '-', end_station_id)) %>%
    count(route, member_casual)

route_prop = 
  trip.route %>%
    pivot_wider(names_from = member_casual, values_from = n, values_fill = 0) %>%
    mutate(total = member+casual) %>%
    filter(total>5) %>% # total sample size of 5 and below will not yield any significant result due to insufficient sample size
    group_by(route) %>%
    nest(-route) %>%
    mutate(test = purrr::map(.x = data,
                             .f = ~prop.test(x = .x$member, n= .x$total, p=0.5) %>% broom::tidy())) %>%
    ungroup() %>%
    unnest(data, test) %>%
    select(route, casual, member, total, p.value) %>%
    filter(p.value < 0.05)

# find IDs of station with higher casual riders than members
casual_route = 
  trip.route %>%
  filter(route %in% route_prop$route) %>%
  filter(!grepl('NA', route)) %>%
  pivot_wider(names_from=member_casual, values_from=n, values_fill = 0) %>%
  mutate(delta = casual-member) %>%
  filter(delta>0) %>%
  arrange(-delta) %>%
  pull(route)

trip.route %>%
  filter(route %in% route_prop$route,
         !grepl('NA', route)) %>%
  pivot_wider(names_from=member_casual, values_from=n, values_fill = 0) %>%
  mutate(delta = casual-member) %>% 
  pivot_longer(-c('route', 'delta'), names_to = 'Membership') %>%
  mutate(start = str_split_fixed(route, pattern = '-', n=2) %>% data.frame %>% pull(X1),
         end = str_split_fixed(route, pattern = '-', n=2) %>% data.frame %>% pull(X2)) %>%
  inner_join(casual_endstation_ref %>% rename(start = end_station_id,
                                              startname = end_station_name), by='start') %>%
  inner_join(casual_endstation_ref %>% rename(end = end_station_id,
                                              endname = end_station_name), by='end') %>%
  mutate(routename = paste(startname, endname, sep=' --> ')) %>%
  mutate(direction = if_else(delta<0, 'Member-dominant', 'Casual-dominant')) %>%
  ggplot(aes(y=reorder(routename, delta), x=value, fill=Membership)) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  labs(x='Usage Frequency', y='Route',
       title = 'Routes with significantly different proportion\nof casual and member riders') +
  facet_wrap(~direction, scales='free_y', ncol=1) + 
  theme_bw() +
  theme(axis.text.y = element_text(size=7))
  
```
Investigating the route confirmed our hypothesis, where stations dominated by casual riders mainly started and ended at the same station. Although we need more data to support this claim, but the much higher proportion of casual riders in these routes might be indicative of their propensity to be used for recreational activity (hence few regular commuters), although this will need to be confirmed by the subject matter expert. Unfortunately, we also do not have information on the number of unique riders per station, which could support or deny this hypothesis.

Nevertheless, knowing that these stations are dominated by casual riders, let's further investigate whether this trend is true throughout the year.

```{r}

trip.route.time = 
  tripdata %>%
  slice_sample(n=100000) %>%
  mutate(route = paste0(start_station_id, '-', end_station_id)) %>%
  mutate(date = lubridate::as_date(started_at),
         ym = str_extract(date, pattern = '^[0-9]{4}-[0-9]{2}'))

# filter route with at least 5 rides 
trip.route.keep = trip.route.time %>% filter(!grepl('NA', route)) %>% count(route) %>% filter(n>50)%>% pull(route)
  
trip.route.time %>%
  filter(route %in% trip.route.keep) %>%
  count(ym, route, member_casual) %>%
  ggplot(aes(x=ym, y=n, fill = member_casual)) +
  geom_col() +
  facet_wrap(~route,scales='free_y', ncol=3) +
  labs(x='Year-month', y='Frequency',
       title = 'Frequency of rides across the year across membership status,\n classified based on stations with >50 rides') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=90),
        legend.position='bottom') 
```

Among stations with >50 rides recorded, there doesn't seem to be a time effect on casual/member riders on the popular routes, with each routes dominated by either member of casual riders throughout the year.

What if we ran the analysis on origin and destination station?

```{r}

# filter only start stations which were previously deemed significant

tripdata %>%
  slice_sample(n=150000) %>%
  drop_na() %>%
  mutate(date = lubridate::as_date(started_at),
         ym = str_extract(date, pattern = '^[0-9]{4}-[0-9]{2}')) %>%
  count(start_station_id, member_casual, ym) %>%
  pivot_wider(names_from = member_casual, values_from = n, values_fill = 0) %>%
  mutate(total = casual+member) %>% 
  filter(total>50) %>%
  pivot_longer(c(member, casual)) %>%
  ggplot(aes(x=ym, y=value, fill = name)) +
  geom_col() + 
  facet_wrap(~start_station_id) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = 'Year-month', y='Frequency of riders',
       title = 'Distribution of riders based on\ntheir membership status in origin stations that saw >50 monthly rides') 

tripdata %>%
  slice_sample(n=150000) %>%
  drop_na() %>%
  mutate(date = lubridate::as_date(started_at),
         ym = str_extract(date, pattern = '^[0-9]{4}-[0-9]{2}')) %>%
  count(end_station_id, member_casual, ym) %>%
  pivot_wider(names_from = member_casual, values_from = n, values_fill = 0) %>%
  mutate(total = casual+member) %>% 
  filter(total>50) %>%
  pivot_longer(c(member, casual)) %>%
  ggplot(aes(x=ym, y=value, fill = name)) +
  geom_col() + 
  facet_wrap(~end_station_id) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = 'Year-month', y='Frequency of riders',
       title = 'Distribution of riders based on\ntheir membership status in target stations that saw >50 monthly rides') 
```

Similar to routes, the distribution of casual and member rides across stations seem to be similar throughout the years.

## Correlation analysis to identify variable associated with ride membership

We managed to identify a few distinction between casual and member riders so far, but let's analyse this statistically to provide some numerical backings to our findings. We will do it by running a correlation analysis between membership and the numerical variables from our dataset (duration, latitude, longitude). 
```{r}

# correlation analysis with numeric factors
cor.num =
  tripdata.sub %>%
  mutate(duration = ended_at - started_at,
         duration = as.integer(duration)) %>%
  select(member_casual, where(is.numeric)) %>%
  mutate(member_casual = ifelse(member_casual == 'member', 1, 0))

library(corrplot)
cor.num.sig = 
  cor.mtest(cor.num %>% drop_na, conf.level = 0.95) %>% 
  reshape2::melt() %>%
  filter(L1 == 'p',
         value<0.05,
         Var1!=Var2) %>%
  select(-L1, -value) %>%
  mutate(link1 = paste0(Var1,Var2),
         link2 = paste0(Var2,Var1)) %>%
  pivot_longer(cols = c(link1,link2)) %>%
  arrange(value) %>% 
  group_by(value) %>%
  slice_head(n=1) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  pull(link1)
  
cor(cor.num %>% drop_na) %>%
  reshape2::melt() %>%
  mutate(link1 = paste0(Var1,Var2)) %>%
  filter(link1 %in% cor.num.sig) %>%
  ggplot(aes(x=Var1, y=Var2, fill = value)) + 
  geom_tile() +
  geom_hline(yintercept = 0.5:4.5, linetype='dashed') +
  geom_vline(xintercept = 0.5:4.5, linetype='dashed') + 
  scale_fill_gradient2(name = 'correlation', breaks = c(-1,0,1), limits = c(-1,1), low = 'indianred', mid = 'white', high = 'steelblue') +
  theme_bw() +
  labs(title = 'Correlation between numeric variables',
       caption = 'Correlation showed exhibited significane value p<0.05',
       x='', y='')

```

The correlation analyses returned some significant features associated with membership status. We have already discussed the correlation between membership and duration previously, so we'll skip this. The correlation between starting and ending latitudes and longitudes likely relates to the common routes being taken. 

One interesting this is the weak negative correlation observed between membership status and start/ending longitude. I will investigate this lead further to see if we can get something.

```{r}
tripdata.sub %>%
  select(member_casual, start_lng, end_lng, start_lat, end_lat) %>%
  pivot_longer(cols = c(start_lng, end_lng), names_to = 'station_remark', values_to = 'lng') %>%
  pivot_longer(cols = c(start_lat, end_lat), names_to='station_remark2', values_to = 'lat') %>%
  separate(station_remark, into = c('lng_remark1', 'lng_remark2')) %>%
  separate(station_remark2, into = c('lat_remark1', 'lat_remark2')) %>%
  select(-lng_remark2, -lat_remark2) %>%
  filter(lng_remark1 == lat_remark1) %>%
  select(-lat_remark1) %>%
  rename(remark = lng_remark1) %>%
  count(member_casual, remark, lng, lat) %>%
  pivot_wider(names_from = member_casual, values_from = n, values_fill = 0) %>% 
  mutate(total = casual + member,
         member_prop = member/total*100) %>%
  ggplot(aes(y=lng, x = lat, color = member_prop )) +
  geom_point(size=0.5) +
  facet_wrap(~remark, labeller = labeller(remark = c('end' = 'End station', 
                                                     'start' = 'Start station'))) +
  theme_bw() +
  scale_color_continuous(name = 'Member proportion (%)') +
  labs(y = 'Longitude', x = 'Latitude',
       title = 'Geoposition of start and end station and membership proportion')
  
```

Although the statistics observed significant correlation between membership status and longitudinal coordinate, this is not immediately visible from the observed graph and is therefore of little impact for any business decision to be derived from this, as also supported by the low correlation value. Hence, let's move on with our analysis.

Now let's find any correlations with the categorical variables.

```{r}
df.cat = 
  tripdata.sub %>% 
  mutate(date = lubridate::as_date(started_at),
         month = lubridate::month(date) %>% as.character,
         year = lubridate::year(date) %>% as.character) %>%
  select(where(is.character)) %>%
  select(!ends_with('name'), -ride_id) %>%
  drop_na() 

janitor::tabyl(df.cat$rideable_type, df.cat$member_casual)

df.cat %>% 
  select(rideable_type, member_casual) %>%
  table() %>%
  prop.table(margin=2) %>% 
  data.frame %>%
  ggplot(aes(x=member_casual, fill = rideable_type, y = Freq*100)) + 
  geom_col() +
  labs(x='Membership type', y='Frequency(%)',
       title = 'Proportion of ride types utilised by membership type') +
  theme_bw()

```

There seems to be different proportion of memberships utilising each of three bike types. Members seem to utilise classic bikes more often than casual riders (54.17% of members ride classics vs 42.14% of casuals), while casuals exhibited almost twice the proportion of docked bike rides (31.94%) against members (20.16%), while electric bike usage was similar across membership status (member vs casual, 25.67% vs 25.91%). 

Is there any breakdown of these between members and casual riders?

```{r}
tripdata.sub %>% 
  mutate(date = lubridate::as_date(started_at),
         day = lubridate::wday(date, label=T),
         month = lubridate::month(date) %>% as.character,
         year = lubridate::year(date) %>% as.character,
         month = factor(month, levels = 1:12)) %>%
  select(rideable_type, day, month, member_casual, year) %>%
  count(member_casual, day,month,year,rideable_type) %>%
  ggplot(aes(x=day, y=n, fill =member_casual)) + 
  geom_col(position = 'dodge') +
  facet_wrap(~rideable_type, ncol=1) +
  theme_bw()
  
```

Interestingly, casual riders outnumbered members in all three ride types on the weekend, with member rides being more frequent than casual riders throughout the weekday. Nevertheless, the difference between members and casual riders were much higher in classic bikes compared to the other two types. 

Is there a specific stations which are more popular on the weekends or weekdays?

```{r, fig.height=10, fig.width=14}
set.seed(123)
tripdata %>%
  drop_na() %>%
  slice_sample(n=150000) %>%
  mutate(day = lubridate::wday(started_at, label = T),
         routename = paste0(start_station_name, '-', end_station_name),
         year = lubridate::year(started_at)) %>% 
  group_by(routename) %>%
  mutate(countroutename = n()) %>%
  ungroup() %>%
  filter(countroutename > 50) %>%
  count(routename, day, year, member_casual, rideable_type) %>%
  ggplot(aes(x=day, y=n, fill = member_casual)) +
  geom_col(position='stack') +
  facet_wrap(~routename, scales='free_y', labeller = label_wrap_gen()) +
  theme_bw() +
  theme(strip.text.x = element_text(size=5),
        axis.text.x = element_text(angle=90)) +
  labs(title = 'Distribution of riders across routes throughout the week')
  
  
```

A lot of stations indeed have a higher number of total rides in the weekend compared to the weekday due to the higher count of casual riders. Frequency of member riders were more station-dependent, with some stations seeing a reduction in members riding on the weekends while others see a relatively constant number. 


Let's check the proportion of bike types across members among the popular stations. 


```{r, fig.width=14, fig.height=12}
set.seed(123)
tripdata %>%
  slice_sample(n = 150000) %>%
  drop_na() %>%
  mutate(route = paste0(start_station_id, '_', end_station_id),
         routename = paste0(start_station_name, '-', end_station_name)) %>%
  group_by(route) %>%
  mutate(count_route = n()) %>%
  ungroup() %>% 
  filter(count_route > 50) %>%
  select(rideable_type, routename, member_casual)%>% 
  count(member_casual, rideable_type, routename) %>%
  group_by(member_casual, routename) %>%
  mutate(prop = n / sum(n)*100) %>% 
  ungroup() %>%
  ggplot(aes(x=member_casual, y=prop, fill=rideable_type)) + 
  geom_col(position='stack') +
  facet_wrap(~routename, labeller = label_wrap_gen()) +
  labs(x='Membership', y='Proportion of bike types (%)',
       title = 'Proportion of bike types used across popular routes with >50 rides') 

ggsave('fig_biketype_station.png', height = 8, width=14)
```

We observe that bike preference was very route-dependen. Generally, casual riders were more likely to ride docked and electric bikes compared to members, who preferred to stick to classic bike. This likely requires more data, for example classic bike likely costs cheaper to ride than docked or electric bikes, hence regular users might prefer the cheaper option compared to the presumed sporadic ride habits of casual members. More data on unique rider ID and cost of rides is needed to ascertain this hypothesis.

Since we observed the weekly trend of casual and member riders throughout the week, let's further look at this by analysing the number of rides taken across membership throughout the week, month, and year. 

We first explore whether there are any variation in the number of rides throughout the year.

```{r}
tripdata.sub %>%
  mutate(date = lubridate::as_date(started_at),
         ym = str_extract(date, pattern = '^[0-9]{4}-[0-9]{2}')) %>%
  arrange(ym) %>% count(ym) %>%
  ggplot(aes(x=ym, y=n)) + 
  scale_y_continuous(breaks = seq(from=0, to=650, by=50)) + 
  geom_hline(yintercept = seq(from=0,to=650, by=100), linetype='dashed') + 
  geom_col() +
  theme_bw() + 
  labs(x='Period(year-month)', y='Count',
       title = 'Number of rides per month between 2020-2022') +
  theme(axis.text.x = element_text(angle=90)) 
  
```

There is much lower number of rides between November and February. Here, we also see that the Cylictic usage peaks at similar time every year, always peaking at either July or August. 

But how do membership status differs across this time?

```{r}

df.cat %>%
  select(month, member_casual, year) %>%
  mutate(month = as.integer(month)) %>%
  count(member_casual, month,year) %>%
  ggplot(aes(x=month, fill = member_casual, y = n)) +
  geom_col(position = 'dodge') +
  theme_bw() +
  labs(y='Count of rides', x='Month',
       title = 'Frequency of member and casual riders across the year') +
  scale_fill_discrete(name = 'Membership') + 
  scale_x_continuous(breaks = 1:12) + 
  facet_wrap(~year,nrow=3)

```

Much higher casual riders were generally observed during the mid-year, around May to August, where there were similar number of casual and member riders. Member riders however outnumbered casual riders during the beginning and end of year, especially at year end.

```{r, fig.width =12, fig.height=9}

tripdata.sub %>% 
  mutate(date = lubridate::as_date(started_at),
         day = lubridate::wday(date, label=T),
         month = lubridate::month(date) %>% as.character,
         year = lubridate::year(date) %>% as.character,
         month = factor(month, levels = 1:12)) %>%
  select(day, month, member_casual, year) %>%
  count(member_casual, day, month, year) %>%
  ggplot(aes(x=day, fill = member_casual, y = n)) +
  geom_col(position = 'dodge') +
  theme_bw() +
  labs(y='Count rides', x='Day',
       title = 'Frequency of member and casual riders across the week') 
```

Looking at the daily breakdown of ride frequency, we observed that casual riders outnumbered members on weekends (Saturday and Sunday), with members being a more frequent rider on the other days. Let's see if this is true across the year.

```{r}
tripdata.sub %>% 
  mutate(date = lubridate::as_date(started_at),
         day = lubridate::wday(date, label=T),
         month = lubridate::month(date) %>% as.character,
         year = lubridate::year(date) %>% as.character,
         month = factor(month, levels = 1:12)) %>%
  select(day, month, member_casual, year) %>%
  count(member_casual, day, month, year) %>%
  ggplot(aes(x=day, fill = member_casual, y = n)) +
  geom_col(position = 'dodge') +
  theme_bw() +
  labs(y='Count rides', x='Day',
       title = 'Frequency of member and casual riders across the week') +
  scale_fill_discrete(name = 'Membership') + 
  facet_grid(month~year) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x='Day', y='Count of rides')

```

We observed that the higher frequency of casual riders during the weekend was only true during peak months as observed earlier. There was much less casual riders compared to members during November and December throughout the 3 year period. 

# Compiling our findings

Let's review our findings:

* Members ride shorter duration then casual riders
* Casual riders greatly outnumbers members in routes around Lake Shore Drive, Streeter Drive & Grand Avenue, and Millenium Park. Most started and ended at the same station
* Higher number of casual riders were observed during the weekends, with member riders outnumbering casual riders during the weekday
* Member riders far outnumber casual riders during on year ends, with comparable number between casual and member on Q2-Q3 yearly.
* Casual riders were more likely to ride docked and electric bikes, although bike choice was route-dependent.
* Casual riders dominated routes that started and ended at the same station
* Casual riders were mugh higher than members on weekends, route analysis found multiple stations where casual riders showed drastic increase during weekends only.

We can generate some hypotheses based on our observation.

* Shorter ride duration likely indicates usage by members for regular commute, with casual members likely using bike rides for sightseeing in recreational area, hence longer duration.
* The above statement was supported by the much higher number of casual riders on weekends, where people are less likely to commute
* The first statement was also supported by fact that members use bike regularly throughout the year compared to casual riders who peaked in midyear but were low during the year-end season.
* Stations which saw high commuting traffic have high ride counts by members, while those in recreation and vacation area have less members and more casual riders.
* Members likely utilises classic bikes due to cost effectiveness or availability.

Of course, these hypotheses needs to be confirmed if possible with further data, such as:

* Unique rider ID, which will tell whether the members are indeed commuters who used the bike regularly on weekday, and whether casual riders are really sporadic user and not regular users.
* Ride cost and availability for different bike types across different locations, which will inform bike preference.
* Ride availability at different locations
* Expert input on which stations and routes constitute hot commute or vacation area.

Unfortunately, this information is insufficient for us to provide a conclusive data-driven recommendation for the stakeholders. More data is needed before we can confidently provide suggestions on how best to convert the casual riders into members. However, here are some suggestions based on several assumptions:

* If casual riders were not one-off users and constituted frequent riders, a subscription-based method which costs less than what the typical rider pay for multiple one-time passes may be persuasive enough to convert these regular casuals into members. This approach is suitable if the company's goal is to capture more members and is willing to cut revenue in the short term, since the director has identified members to be more profitable in the long run.

* The above campaign should be targeted to areas with high proportion of casual riders such as Streeter Drive and Lake Shore Drive.

* Cyclistic could offer a new weekend-only membership plan for regular casual riders who frequently used the bike on the weekends, but are not members due to the lack of usage on weekdays, hence deterring a subscription plan (which could be more expensive than purchasing day passes if only used on the weekends).

* If casual riders preferred docked and electric bikes and this is not due to limitations of bike choices in the stations, Cyclistic could limit the usage of these bikes to members only, which could entice casuals to convert their membership. This option should be further evaluated with the market demands of Cyclistic bikes, as it could backfire and led to reduced usage of bikes without any membership conversion.




